% Protecting the weak signals in distributed acoustic sensing data processing using local orthogonalization: the FORGE data example

% Script to plot Figure 8

%  Copyright (C) Oboue et al., 2022

%  This program is free software: you can redistribute it and/or modify
%  it under the terms of the GNU General Public License as published
%  by the Free Software Foundation, either version 3 of the License, or
%  any later version.

%  This program is distributed in the hope that it will be useful,
%  but WITHOUT ANY WARRANTY; without even the implied warranty of
%  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
%  GNU General Public License for more details: http://www.gnu.org/licenses/

%  References

%  Oboue et al., 2022
%  Huang, G., M. Bai, Q. Zhao, W. Chen, and Y. Chen, 2021, Erratic noise suppression using iterative structure-oriented space-varying median filtering with sparsity constraint, Geophysical Prospecting, 69, 101-121.
%  Chen, Y., S. Zu, Y. Wang, and X. Chen, 2020, Deblending of simultaneous-source data using a structure-oriented space varying median filter, Geophysical Journal International, 222, 1805�1�723.
%  Zhao, Q., Q. Du, X. Gong, and Y. Chen, 2018, Signal-preserving erratic noise attenuation via iterative robust sparsity-promoting filter, IEEE Transactions on Geoscience and Remote Sensing, 56, 1558-0644.
%-------------------------------------------------------------------------
clc;clear;close all;
%% addpath
addpath('../LO_data/');
addpath('../LOsrcs/');
addpath('../seistr/');
%% Ccomparison between SOMF, SOSVMF methods
%% Load the DAS data

NOs=[1,20,10,25,11,2];
labels={...                                             %P-arrival sample NO from the SEGY file
    'FORGE\_78-32\_iDASv3-P11\_UTC190423150554.sgy',... %24169
    'FORGE\_78-32\_iDASv3-P11\_UTC190426070723.sgy',... %24811
    'FORGE\_78-32\_iDASv3-P11\_UTC190426062208.sgy',... %26090
    'FORGE\_78-32\_iDASv3-P11\_UTC190426110008.sgy',... %4921
    'FORGE\_78-32\_iDASv3-P11\_UTC190426062553.sgy',... %8934
    'FORGE\_78-32\_iDASv3-P11\_UTC190423182409.sgy'};   %4210

eq=zeros(2000,960);
[n1,n2]=size(eq);
t=[0:n1]*0.0005;
ngap=50;
x=1:n2*3+2*ngap;

for ii=3
    if ~ismember(ii,[14,16,17,27,47,52])
        strcat('LO_data/eq-',num2str(ii),'.mat')
        load(strcat('LO_data/eq-',num2str(ii),'.mat'));
    end
%   d1=d1;
    eq=d1;
    din=d1;

%% Denosing using the BP method
%  Parameter tuning for the BP method
%
dt=0.0005; % sampling
flo=0;     % Low frequency in band, default is 0
fhi=200;   % High frequency in band, default is Nyquist
nplo=6;    % number of poles for low cutoff
nphi=6;    % number of poles for high cutoff
phase=0;   % y: minimum phase, n: zero phase
verb0=0;   % verbosity flag
%
tic
d_bp=LO_bandpass(din,dt,flo,fhi,nplo,nphi,phase,verb0);
toc
%% Denosing using the BP+LO (LO) method
rec = zeros(3, 1);    % 3-D vector denoting smooth radius 
rec(1) = 30;
rec(2) = 30;
rec(3) = 1;
eps1=0;               % regularization parameter, default 0.0
niter2=20;            % number of CG iterations
verb2=1;              % verbosity flag (default: 0)
%
tic
d_bplow=LO_bandpasslow(din,dt,flo,fhi,nplo,nphi,phase,verb0,rec,eps1,niter2,verb2);
toc
%
comp1=[din,zeros(n1,ngap),d_bp,din-d_bp,zeros(n1,ngap),d_bplow,din-d_bplow]; 
%% Denoising using the SOSVMF method
%
niter=2;                      % number of nonlinear iterations
liter=10;                     % liter: number of linear iterations (in divn)
order1=3;                     % order: accuracy order
eps_dv=0.01;                  % eps_dv: eps for divn  (default: 0.01)
eps_cg=1;                     % eps_cg: eps for CG    (default: 1)
tol_cg=0.000001;              % tol_cg: tolerence for CG (default: 0.000001)
rect(1)=50;                   % rect:  smoothing radius (ndim*1)
rect(2)=50;                   % "      "        "
rect(3)=1;                    % "      "        "
verb1=1;                      % verbosity flag

adj=0;                        % adjoint flag
add=0;                        % adding flag
ns=8;                         % spray radius
order2=2;                     % PWD order
eps=0.01;                     % regularization (default:0.01);
ndn=n1*n2;                    % size of dn (n1*n2)
nds=n1*n2;                    % size of ds (n1*n2)
type_mf=1;                    % 0 (MF) or 1 (SVMF)
ifsmooth=0;                   % 1 (if smooth) or 0 (only MF);

%
tic
d_sosvmf=LO_sosvmf(din,niter,liter,order1,eps_dv, eps_cg, tol_cg,rect,verb1,adj,add,n1,n2,ns,order2,eps,ndn,nds,type_mf,ifsmooth);
toc
%
%% Denoising using the SOSVMF+LOW (LO) method
rec = zeros(3, 1);    % 3-D vector denoting smooth radius 
rec(1) = 30;
rec(2) = 30;
rec(3) = 1;
eps1=0;               % regularization parameter, default 0.0
niter2=20;            % number of CG iterations
verb2=1;              % verbosity flag (default: 0) 
%
tic
d_sosvmflow=LO_sosvmflow(din,niter,liter,order1,eps_dv, eps_cg, tol_cg,rect,verb1,adj,add,n1,n2,ns,order2,eps,ndn,nds,type_mf,ifsmooth,rec,eps1,niter2,verb2);
toc
%
comp2=[din,zeros(n1,ngap),d_sosvmf,din-d_sosvmf,zeros(n1,ngap),d_sosvmflow,din-d_sosvmflow]; 
%% Denoising using the FK dip method
%
w=0.1;   % half width (in percentage) of the cone filter (i.e., w*nk=nwidth)
%
tic
d_fk=din-LO_fk_dip(din,w);
toc
%
%% Denoising using the FK+LOW (LO) method
tic 
d_fklow=LO_fk_diplow(din,w,rec,niter2,eps1,verb2);
toc
%
comp3=[din,zeros(n1,ngap),d_fk,din-d_fk,zeros(n1,ngap),d_fklow,din-d_fklow]; 
%% Denoising using the curvelet method

c1=1;                % Type of the transform(0: complex-valued curvelets,1: real-valued curvelets)
c2=1;                % Chooses one of two possibilities for the coefficients at the finest level(1: curvelets,2: wavelets)
c3=5;                % Thresholding parameter (alpha)
niter1=10;           % Number of iteration
d_est=din;
%
tic
d_curvelet=LO_curvelet(din,d_est,n1,n2,c1,c2,c3,niter1);
toc
%
%% Denoising using the curvelet+LOW (LO) method

rec = zeros(3, 1);    % 3-D vector denoting smooth radius 
rec(1) = 30;
rec(2) = 30;
rec(3) = 1;
eps1=0;               % regularization parameter, default 0.0
niter2=20;            % number of CG iterations
verb2=1;              % verbosity flag (default: 0) 

d_curveletlow=LO_curveletlow(din,n1,n2,c1,c2,c3,niter1,rec,eps1,niter2,verb2);

comp4=[din,zeros(n1,ngap),d_curvelet,din-d_curvelet,zeros(n1,ngap),d_curveletlow,din-d_curveletlow]; 
end

%% Plot figures

t=[0:n1]*0.0005;
% ngap0=1000;

ngap=50;
x=1:n2*3+2*ngap;

% combined figure
figure('units','normalized','Position',[0.0 0.0 0.5, 1],'color','w');
subplot(4,1,1);LO_imagesc(comp1,100,2,x,t);
ylabel('Time (s)','Fontsize',14,'fontweight','bold');
xlabel('Channel','Fontsize',14,'fontweight','bold');
set(gca,'Linewidth',2,'Fontsize',14,'Fontweight','bold');
text(n2/3.5,-0.09,'Raw data','color','k','Fontsize',14,'fontweight','bold','HorizontalAlignment','center');
text(n2/0.79,-0.09,'BP','color','k','Fontsize',12,'fontweight','bold','HorizontalAlignment','center');
text(n2/0.4,-0.09,'BP+LOW (LO)','color','k','Fontsize',14,'fontweight','bold','HorizontalAlignment','center');
text(-200,-0.1,'(a)','color','k','Fontsize',16,'fontweight','bold','HorizontalAlignment','center');
annotation(gcf,'textarrow',[0.358465608465608 0.411375661375661],...
    [0.850546780072899 0.891859052247869],'Color',[1 0 0],'TextColor',[1 0 0],...
    'String',{'High-amplitude','erratic noise'},...
    'LineWidth',2,...
    'HorizontalAlignment','center',...
    'FontWeight','bold',...
    'FontSize',14,...
    'FontName','Helvetica Neue');
annotation(gcf,'textarrow',[0.519841269841268 0.562169312169311],...
    [0.876063183475087 0.905224787363304],'Color',[1 0 0],'TextColor',[1 0 0],...
    'String',{'Visible','signal','leakage'},...
    'LineWidth',2,...
    'HorizontalAlignment','center',...
    'FontWeight','bold',...
    'FontSize',14,...
    'FontName','Helvetica Neue');
annotation(gcf,'textarrow',[0.687830687830687 0.723544973544971],...
    [0.856622114216279 0.891859052247867],'Color',[1 0 0],'TextColor',[1 0 0],...
    'LineWidth',2,...
    'HorizontalAlignment','center',...
    'FontWeight','bold',...
    'FontSize',14,...
    'FontName','Helvetica Neue');
annotation(gcf,'textarrow',[0.834656084656079 0.873015873015869],...
    [0.880923450789786 0.906439854191977],'Color',[1 0 0],'TextColor',[1 0 0],...
    'LineWidth',2,...
    'HorizontalAlignment','center',...
    'FontWeight','bold',...
    'FontSize',14,...
    'FontName','Helvetica Neue');
subplot(4,1,2);LO_imagesc(comp2,100,2,x,t);
ylabel('Time (s)','Fontsize',14,'fontweight','bold');
xlabel('Channel','Fontsize',14,'fontweight','bold');
set(gca,'Linewidth',2,'Fontsize',14,'Fontweight','bold');
text(n2/3.5,-0.09,'Raw data','color','k','Fontsize',14,'fontweight','bold','HorizontalAlignment','center');
text(n2/0.79,-0.09,'SOSVMF','color','k','Fontsize',12,'fontweight','bold','HorizontalAlignment','center');
text(n2/0.4,-0.09,'SOSVMF+LOW (LO)','color','k','Fontsize',14,'fontweight','bold','HorizontalAlignment','center');
text(-200,-0.1,'(b)','color','k','Fontsize',16,'fontweight','bold','HorizontalAlignment','center');
annotation(gcf,'textarrow',[0.37962962962963 0.411375661375659],...
    [0.659781287970838 0.659781287970832],'Color',[1 0 0],'TextColor',[1 0 0],...
    'LineWidth',2,...
    'HorizontalAlignment','center',...
    'FontWeight','bold',...
    'FontSize',14,...
    'FontName','Helvetica Neue');
annotation(gcf,'textarrow',[0.396825396825396 0.411375661375659],...
    [0.586877278250302 0.612393681652486],'Color',[1 0 0],'TextColor',[1 0 0],...
    'LineWidth',2,...
    'HorizontalAlignment','center',...
    'FontWeight','bold',...
    'FontSize',14,...
    'FontName','Helvetica Neue');
annotation(gcf,'textarrow',[0.447089947089947 0.460317460317459],...
    [0.622114216281894 0.659781287970835],'Color',[1 0 0],'TextColor',[1 0 0],...
    'LineWidth',2,...
    'HorizontalAlignment','center',...
    'FontWeight','bold',...
    'FontSize',14,...
    'FontName','Helvetica Neue');
annotation(gcf,'textarrow',[0.523809523809522 0.56084656084656],...
    [0.641555285540699 0.616038882138516],'Color',[1 0 0],'TextColor',[1 0 0],...
    'String',{'Stronger','signal','leakage'},...
    'LineWidth',2,...
    'HorizontalAlignment','center',...
    'FontWeight','bold',...
    'FontSize',14,...
    'FontName','Helvetica Neue');
annotation(gcf,'textarrow',[0.682539682539681 0.714285714285711],...
    [0.659781287970836 0.65978128797083],'Color',[1 0 0],'TextColor',[1 0 0],...
    'LineWidth',2,...
    'HorizontalAlignment','center',...
    'FontWeight','bold',...
    'FontSize',14,...
    'FontName','Helvetica Neue');
annotation(gcf,'textarrow',[0.708994708994708 0.723544973544972],...
    [0.586877278250302 0.612393681652486],'Color',[1 0 0],'TextColor',[1 0 0],...
    'LineWidth',2,...
    'HorizontalAlignment','center',...
    'FontWeight','bold',...
    'FontSize',14,...
    'FontName','Helvetica Neue');
annotation(gcf,'textarrow',[0.759259259259257 0.772486772486769],...
    [0.614823815309839 0.65249088699878],'Color',[1 0 0],'TextColor',[1 0 0],...
    'LineWidth',2,...
    'HorizontalAlignment','center',...
    'FontWeight','bold',...
    'FontSize',14,...
    'FontName','Helvetica Neue');
annotation(gcf,'textarrow',[0.832010582010577 0.869047619047615],...
    [0.647630619684073 0.62211421628189],'Color',[1 0 0],'TextColor',[1 0 0],...
    'LineWidth',2,...
    'HorizontalAlignment','center',...
    'FontWeight','bold',...
    'FontSize',14,...
    'FontName','Helvetica Neue');

subplot(4,1,3);LO_imagesc(comp3,100,2,x,t);
ylabel('Time (s)','Fontsize',14,'fontweight','bold');
xlabel('Channel','Fontsize',14,'fontweight','bold');
set(gca,'Linewidth',2,'Fontsize',14,'Fontweight','bold');
text(n2/3.5,-0.09,'Raw data','color','k','Fontsize',14,'fontweight','bold','HorizontalAlignment','center');
text(n2/0.79,-0.09,'FK','color','k','Fontsize',12,'fontweight','bold','HorizontalAlignment','center');
text(n2/0.4,-0.09,'FK+LOW (LO)','color','k','Fontsize',14,'fontweight','bold','HorizontalAlignment','center');
text(-200,-0.1,'(c)','color','k','Fontsize',16,'fontweight','bold','HorizontalAlignment','center');
annotation(gcf,'textarrow',[0.365079365079363 0.412698412698412],...
    [0.422843256379097 0.452004860267312],'Color',[1 0 0],'TextColor',[1 0 0],...
    'String',{'High-amplitude','erratic noise'},...
    'LineWidth',2,...
    'HorizontalAlignment','center',...
    'FontWeight','bold',...
    'FontSize',14,...
    'FontName','Helvetica Neue');
annotation(gcf,'textarrow',[0.535714285714285 0.58068783068783],...
    [0.44228432563791 0.413122721749696],'Color',[1 0 0],'TextColor',[1 0 0],...
    'String',{'Stronger signal','leakage'},...
    'LineWidth',2,...
    'HorizontalAlignment','center',...
    'FontWeight','bold',...
    'FontSize',14,...
    'FontName','Helvetica Neue');
annotation(gcf,'textarrow',[0.706349206349205 0.720899470899468],...
    [0.414337788578369 0.439854191980553],'Color',[1 0 0],'TextColor',[1 0 0],...
    'LineWidth',2,...
    'HorizontalAlignment','center',...
    'FontWeight','bold',...
    'FontSize',14,...
    'FontName','Helvetica Neue');
annotation(gcf,'textarrow',[0.851851851851847 0.888888888888886],...
    [0.441069258809224 0.415552855407042],'Color',[1 0 0],'TextColor',[1 0 0],...
    'LineWidth',2,...
    'HorizontalAlignment','center',...
    'FontWeight','bold',...
    'FontSize',14,...
    'FontName','Helvetica Neue');
subplot(4,1,4);LO_imagesc(comp4,100,2,x,t);
ylabel('Time (s)','Fontsize',14,'fontweight','bold');
xlabel('Channel','Fontsize',14,'fontweight','bold');
set(gca,'Linewidth',2,'Fontsize',14,'Fontweight','bold');
text(n2/3.5,-0.09,'Raw data','color','k','Fontsize',14,'fontweight','bold','HorizontalAlignment','center');
text(n2/0.79,-0.09,'Curvelet','color','k','Fontsize',12,'fontweight','bold','HorizontalAlignment','center');
text(n2/0.4,-0.09,'Curvelet+LOW (LO)','color','k','Fontsize',14,'fontweight','bold','HorizontalAlignment','center');
text(-200,-0.1,'(d)','color','k','Fontsize',16,'fontweight','bold','HorizontalAlignment','center');

annotation(gcf,'textarrow',[0.363756613756612 0.411375661375661],...
    [0.20534629404617 0.234507897934384],'Color',[1 0 0],'TextColor',[1 0 0],...
    'String',{'High-amplitude','erratic noise'},...
    'LineWidth',2,...
    'HorizontalAlignment','center',...
    'FontWeight','bold',...
    'FontSize',14,...
    'FontName','Helvetica Neue');
annotation(gcf,'textarrow',[0.484126984126983 0.465608465608462],...
    [0.204131227217496 0.23207776427703],'Color',[1 0 0],'TextColor',[1 0 0],...
    'String',{'visible','signal','leakage'},...
    'LineWidth',2,...
    'HorizontalAlignment','center',...
    'FontWeight','bold',...
    'FontSize',14,...
    'FontName','Helvetica Neue');
annotation(gcf,'textarrow',[0.706349206349205 0.720899470899468],...
    [0.198055893074116 0.2235722964763],'Color',[1 0 0],'TextColor',[1 0 0],...
    'LineWidth',2,...
    'HorizontalAlignment','center',...
    'FontWeight','bold',...
    'FontSize',14,...
    'FontName','Helvetica Neue');
annotation(gcf,'textarrow',[0.798941798941798 0.780423280423277],...
    [0.21142162818955 0.239368165249083],'Color',[1 0 0],'TextColor',[1 0 0],...
    'LineWidth',2,...
    'HorizontalAlignment','center',...
    'FontWeight','bold',...
    'FontSize',14,...
    'FontName','Helvetica Neue');

print(gcf,'-depsc','-r300','fig8.eps');


